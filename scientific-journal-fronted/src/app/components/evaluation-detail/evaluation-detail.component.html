<p-toast></p-toast>

<p-toolbar styleClass="mb-6">
  <ng-template pTemplate="start">
    <p-button label="Nuevo" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
  </ng-template>
  <ng-template pTemplate="end">
    <p-button label="Exportar" icon="pi pi-upload" severity="secondary" (click)="exportCSV()" />
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="details()"
  [rows]="10"
  [columns]="cols"
  [paginator]="true"
  [globalFilterFields]="['description','evaluationStatus']"
  [tableStyle]="{ 'min-width': '50rem' }"
  [(selection)]="selectedDetails"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} detalles"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[5,10,20]"
>
  <!-- TÍTULO Y BUSCADOR -->
  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between w-full">
      <h5 class="m-0">Gestión de Detalles de Dictamen</h5>
      <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
    </div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th *ngFor="let col of cols" [pSortableColumn]="col.field">
        {{ col.header }}<p-sortIcon [field]="col.field"></p-sortIcon>
      </th>
      <th style="min-width: 8rem"></th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-detail>
    <tr>
      <td>
        {{ getArticleName(detail.evaluationId) }} - {{ getReviewerName(detail.evaluationId) }}
      </td>
      <td>
        <div class="description-cell">
          {{ detail.description }}
        </div>
      </td>
      <td>{{ getStatusLabel(detail.evaluationStatus) }}</td>
      <td>
        <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editDetail(detail)" />
        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteDetail(detail)" />
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog [(visible)]="detailDialog"
          [style]="{ width: '480px', height: '500px', 'border-radius': '12px', 'overflow-y': 'auto' }"
          header="Detalles del Dictamen"
          [modal]="true">
  <ng-template pTemplate="content">
    <form class="p-fluid" autocomplete="off">
      <div class="p-field mb-4">
        <label for="evaluationId" class="font-semibold mb-2" style="display:block; margin-bottom: 8px;">Evaluación</label>
        <p-dropdown
          [options]="evaluations"
          [(ngModel)]="detail.evaluationId"
          name="evaluationId"
          placeholder="Seleccione una evaluación"
          [showClear]="true"
          required
          [style]="{ width: '100%' }"
          [optionLabel]="'label'"
          [optionValue]="'id'"
        >
          <ng-template let-eval pTemplate="item">
            <span>{{ getArticleName(eval.value) }} - {{ getReviewerName(eval.value) }}</span>
          </ng-template>
        </p-dropdown>
        <small class="p-error" *ngIf="submitted && !detail.evaluationId">
          La evaluación es requerida.
        </small>
      </div>
      <div class="p-field mb-4">
        <label for="description" class="font-semibold mb-2" style="display:block; margin-bottom: 8px;">Descripción</label>
        <textarea
          pInputTextarea
          id="description"
          [(ngModel)]="detail.description"
          name="description"
          required
          class="with-border"
          [style]="{ width: '100%' }"
          rows="4"
        ></textarea>
        <small class="p-error" *ngIf="submitted && detail.description.trim().length === 0">
          La descripción es requerida.
        </small>
      </div>
      <div class="p-field mb-4">
        <label for="evaluationStatus" class="font-semibold mb-2" style="display:block; margin-bottom: 8px;">Estado</label>
        <p-dropdown
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="detail.evaluationStatus"
          name="evaluationStatus"
          placeholder="Seleccione un estado"
          [showClear]="true"
          required
          [style]="{ width: '100%' }"
        ></p-dropdown>
        <small class="p-error" *ngIf="submitted && !detail.evaluationStatus">
          El estado es requerido.
        </small>
      </div>
    </form>
  </ng-template>
  <ng-template pTemplate="footer">
    <div class="flex justify-center w-full gap-2">
      <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
      <p-button label="Guardar" icon="pi pi-check" (click)="saveDetail()" />
    </div>
  </ng-template>
</p-dialog>
<p-confirmdialog [style]="{ width: '400px' }" />